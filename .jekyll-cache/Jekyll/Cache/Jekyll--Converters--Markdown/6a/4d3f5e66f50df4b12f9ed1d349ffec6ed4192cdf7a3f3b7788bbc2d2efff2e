I"√<p><img src="/images/prefect.jpeg" alt="" /></p>

<hr />

<p>So, I‚Äôve been getting more interested in Data Engineering lately (who <a href="https://www.datanami.com/2020/02/12/demand-for-data-engineers-up-50/">hasn‚Äôt</a>?). What began with helping a client get data from their revenue management system to the cloud via a clunky Python script has now become a bit of a more vested interest in the happenings of this field. I happened to run across a post about <a href="https://prefect.io">Prefect</a> on Reddit (where else?) discussing the differences between it and Apache Airflow. (Full disclaimer, I‚Äôve never used or worked with Airflow, so this article will not be about that.) Letting my intrigue get the best of me, I decided to think up a little side project for myself to test this out for myself.</p>

<p>I‚Äôve been wearing an Apple Watch for quite a while now, and while I‚Äôve used it to track workouts, pace, and sleep, I haven‚Äôt taken the time to look at much of the data in aggregate. Some of the most interesting data visualizations as well as problems involve a sense of time (<strong>Announcement</strong>: I have a post on K-means adapted for time series data in the works, so check back soon). Needing a reason to build a data pipeline, I figured now was the time I‚Äôd run a full export of my data and see what I could learn from it.</p>

<h2 id="prefect">Prefect</h2>
<p>Prefect is made up of a couple components, the UI and Agent.</p>

<h3 id="ui">UI</h3>
<p>Prefect UI is where you‚Äôll view your flows, schedule runs, and see older versions and data on past runs. The power of Prefect is that this comes setup with a GraphQL API that executes runs, handles errors, restarts runs, and can send notifications to messaging services like Slack or Twilio. For my database nerds, it stores cache and results data on a Postgres Database. All of this comes neatly in a Docker container that you can run on your own server. That said, their full featured UI lives at <a href="https://cloud.prefect.io">cloud.prefect.io</a>. To focus on the pipeline building, you can create an account to access their full-featured UI and you‚Äôll have the same tools and more at your fingertips.</p>

<h3 id="agent">Agent</h3>
<p>The Prefect Agent will run on your own private Virtual Machines, Kubernetes cluster, or even Dask cluster. This is where we install Python dependencies, register our flows, and run them.</p>

<p>An important distinction: <strong>This is the only place your codebase will exist.</strong></p>

<p>The reason this is so important is because it completely changes the risk landscape from the perspective of IT in your organization. When you register a flow, Prefect generates the metadata on the flow and that is all it needs to be able to make API calls via their cloud UI and GraphQL. Keeping your private codebase on your network or cloud account, always.</p>

<h2 id="building-the-pipeline">Building the Pipeline</h2>

<p>To keep this short and somewhat OS agnostic, I won‚Äôt go over the specifics of writing the iPhone automation in the Shortcuts app to schedule the export of my Health data. I‚Äôve been told it‚Äôs possible to do this on Android as well, but I‚Äôll leave it to you to map out how you‚Äôll schedule or push your health data periodically from your device. However you do it, you‚Äôll want to push the export to somewhere that has an API so you can pick the data up via Python.</p>

<h3 id="spinning-up-your-local-env">Spinning up your local Env</h3>
<p>To start, we need a computer! This could be your local machine, but if you‚Äôve got some free credits for a cloud platform like I do, you can spin up a VM. I‚Äôm using Google Cloud Platform, to create an instance you can follow <a href="https://cloud.google.com/compute/docs/instances/create-start-instance">this</a> documentation. Depending on you workload, you may be able to use a free tier VM anyways, but for the amount of processing power I need I‚Äôm not able to.</p>

<h3 id="package-dependencies">Package Dependencies</h3>
<p>Once you‚Äôve created your VM, SSH into it. Assuming you‚Äôve got Python installed on your VM (GCP VMs come with it), you can pull the packages you‚Äôll need for this from my public Github repo for this project by running (it‚Äôs a good idea to create a <a href="https://docs.python.org/3/library/venv.html">venv</a> first to install into):</p>

<div class="code-header">
    <button class="copy-code-button" aria-label="Copy code to clipboard"></button>
</div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pip <span class="nb">install</span> <span class="nt">-r</span> https://raw.githubusercontent.com/trouze/Apple-Health-App/main/requirements.txt
</code></pre></div></div>

<p>This file doesn‚Äôt include <code class="language-plaintext highlighter-rouge">Pyicloud</code>, which I use for accessing data on my iCloud. Use whatever you need to access your saved data. Additionally, there are some Prefect optional dependencies we need to specify via this call:</p>

<div class="code-header">
    <button class="copy-code-button" aria-label="Copy code to clipboard"></button>
</div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pip <span class="nb">install</span> <span class="s2">"prefect[gcp,google]"</span>
</code></pre></div></div>

<p>If you were to run your pipeline on Kubernetes, the above call is where you‚Äôd specify that additional dependency. You can see all options <a href="https://docs.prefect.io/core/getting_started/install.html#installing-optional-dependencies">here</a>. For this tutorial, I‚Äôll just run the agent on a single virtual machine.</p>

<h3 id="register-your-agent">Register your Agent</h3>
<p>To facilitate the ‚Äúhandshake‚Äù between Prefect‚Äôs Cloud UI and our Server Agent, we must generate an API key in the UI and make a call via our virtual machine‚Äôs command line to register the agent. If you‚Äôve already created an account with <a href="cloud.prefect.io">Prefect Cloud UI</a>, then follow the beautiful diagram below to create an API key.</p>

<p><img src="/images/prefect-api-key.png" alt="" /></p>

<p>Copy the API key that is generated and SSH into your virtual machine. We‚Äôre going to use a Local Agent, but there are other <a href="https://docs.prefect.io/orchestration/agents/overview.html#agent-types">agent types</a> that are better for modularity. We‚Äôll use local for the simplicity and needs at this point. With the API key copied to the clipboard run the following in the virtual machine bash:</p>

<div class="code-header">
    <button class="copy-code-button" aria-label="Copy code to clipboard"></button>
</div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>prefect agent <span class="nb">local </span>start <span class="nt">--key</span> <span class="s2">"API_KEY"</span>
</code></pre></div></div>

<p>Great! Now our machine is registered and able to connect to Prefect Cloud UI. You can ctrl+c to shut down the agent, as we‚Äôll begin developing an example pipeline and mount it on our machine.</p>

<h2 id="building-the-pipeline-in-python">Building The Pipeline in Python</h2>

<h3 id="tasks-secrets-flows">Tasks, Secrets, Flows</h3>

<h4 id="pushing-pipeline-files-to-the-vm">Pushing Pipeline Files to the VM</h4>
<p>do this via gcloud command line</p>

<h3 id="registering-the-flow">Registering the Flow</h3>

<h3 id="starting-the-agent">Starting the Agent</h3>
<p>nohup prefect agent local start &amp;</p>

<h3 id="using-the-ui-to-schedule-and-run-flows">Using the UI to Schedule and Run Flows</h3>

<h2 id="whats-next">What‚Äôs Next?</h2>
<p>I love this orchestration platform, and the true power of it just might be in ML model training. Using this service, we can schedule runs to retrain our models based on new data, always keeping parameters up to date when data changes. I may work to integrate this into the trading bot project I started a while back, so stay tuned.</p>
:ET